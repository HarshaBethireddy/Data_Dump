// Add these new classes and methods to your ExtractAndCompare.java file

// ============================================================================
// NEW CLASSES FOR EXCEL REPORT GENERATION
// ============================================================================

/**
 * Represents a comparison result for a single application
 */
static class ComparisonResult {
    String fileName;
    String preAppId;
    String postAppId;
    String category;
    String status; // "MATCHED" or "DIFFERENCES FOUND"
    int totalDifferences;
    int preFileLines;
    int postFileLines;
    List<DifferenceDetail> differences;
    
    ComparisonResult() {
        differences = new ArrayList<>();
    }
}

/**
 * Represents a single difference between PRE and POST files
 */
static class DifferenceDetail {
    int lineNumber;
    String path;
    String bureau;
    String type;
    String parsed;
    String preContent;
    String postContent;
    
    DifferenceDetail(int lineNumber, String path, String bureau, String type, 
                     String parsed, String preContent, String postContent) {
        this.lineNumber = lineNumber;
        this.path = path != null ? path : "";
        this.bureau = bureau != null ? bureau : "";
        this.type = type != null ? type : "";
        this.parsed = parsed != null ? parsed : "";
        this.preContent = preContent != null ? preContent : "";
        this.postContent = postContent != null ? postContent : "";
    }
}

// ============================================================================
// EXCEL REPORT GENERATION METHODS
// ============================================================================

/**
 * Parse the master comparison report text file and generate Excel
 */
private static void generateExcelReport(String masterReportPath, String outputFolder) {
    try {
        System.out.println("\n=== Generating Excel Report ===");
        
        // Parse the text report
        List<ComparisonResult> results = parseMasterReport(masterReportPath);
        System.out.println("Parsed " + results.size() + " comparison results");
        
        // Generate Excel workbook
        String excelPath = outputFolder + "\\MASTER_Comparison_Report.xlsx";
        createComparisonExcel(results, excelPath);
        
        System.out.println("✅ Excel report generated: " + excelPath);
    } catch (Exception e) {
        System.err.println("❌ Error generating Excel report: " + e.getMessage());
        e.printStackTrace();
    }
}

/**
 * Parse the master comparison report text file
 */
private static List<ComparisonResult> parseMasterReport(String reportPath) throws IOException {
    List<ComparisonResult> results = new ArrayList<>();
    List<String> lines = Files.readAllLines(Paths.get(reportPath));
    
    ComparisonResult currentResult = null;
    DifferenceDetail currentDiff = null;
    boolean inDiffSection = false;
    String lastPathLine = null;
    
    for (int i = 0; i < lines.size(); i++) {
        String line = lines.get(i).trim();
        
        // Start of new file comparison
        if (line.startsWith("FILE: ")) {
            if (currentResult != null) {
                results.add(currentResult);
            }
            currentResult = new ComparisonResult();
            currentResult.fileName = line.substring(6).trim();
            inDiffSection = false;
        }
        // PRE APP ID
        else if (line.startsWith("PRE APP ID:") && currentResult != null) {
            currentResult.preAppId = line.substring(11).trim();
        }
        // POST APP ID
        else if (line.startsWith("POST APP ID:") && currentResult != null) {
            currentResult.postAppId = line.substring(12).trim();
        }
        // Status
        else if (line.startsWith("Status:") && currentResult != null) {
            String status = line.substring(7).trim();
            if (status.startsWith("MATCHED")) {
                currentResult.status = "MATCHED";
                currentResult.totalDifferences = 0;
            } else if (status.startsWith("DIFFERENCES FOUND")) {
                currentResult.status = "DIFFERENCES FOUND";
                inDiffSection = true;
            }
        }
        // Pre file lines
        else if (line.startsWith("Pre file lines:") && currentResult != null) {
            try {
                currentResult.preFileLines = Integer.parseInt(line.substring(15).trim());
            } catch (NumberFormatException e) {
                currentResult.preFileLines = 0;
            }
        }
        // Post file lines
        else if (line.startsWith("Post file lines:") && currentResult != null) {
            try {
                currentResult.postFileLines = Integer.parseInt(line.substring(16).trim());
            } catch (NumberFormatException e) {
                currentResult.postFileLines = 0;
            }
        }
        // Line number (start of difference)
        else if (line.matches("Line \\d+:") && currentResult != null && inDiffSection) {
            if (currentDiff != null) {
                currentResult.differences.add(currentDiff);
            }
            int lineNum = Integer.parseInt(line.substring(5, line.length() - 1).trim());
            currentDiff = new DifferenceDetail(lineNum, "", "", "", "", "", "");
        }
        // Path
        else if (line.startsWith("Path:") && currentDiff != null) {
            currentDiff.path = line.substring(5).trim();
            lastPathLine = currentDiff.path;
        }
        // Bureau, Type, Parsed (combined line)
        else if (line.startsWith("Bureau:") && currentDiff != null) {
            String[] parts = line.split("\\|");
            for (String part : parts) {
                part = part.trim();
                if (part.startsWith("Bureau:")) {
                    currentDiff.bureau = part.substring(7).trim();
                } else if (part.startsWith("Type:")) {
                    currentDiff.type = part.substring(5).trim();
                } else if (part.startsWith("Parsed:")) {
                    currentDiff.parsed = part.substring(7).trim();
                }
            }
        }
        // PRE content
        else if (line.startsWith("PRE:") && currentDiff != null) {
            currentDiff.preContent = line.substring(4).trim();
        }
        // POST content
        else if (line.startsWith("POST:") && currentDiff != null) {
            currentDiff.postContent = line.substring(5).trim();
        }
        // Total differences found
        else if (line.startsWith("Total differences found:") && currentResult != null) {
            try {
                currentResult.totalDifferences = Integer.parseInt(
                    line.substring(24).trim());
            } catch (NumberFormatException e) {
                currentResult.totalDifferences = currentResult.differences.size();
            }
        }
    }
    
    // Add last difference and result
    if (currentDiff != null && currentResult != null) {
        currentResult.differences.add(currentDiff);
    }
    if (currentResult != null) {
        results.add(currentResult);
    }
    
    return results;
}

/**
 * Create Excel workbook with multiple sheets
 */
private static void createComparisonExcel(List<ComparisonResult> results, 
                                         String excelPath) throws IOException {
    try (Workbook workbook = new XSSFWorkbook()) {
        
        // Sheet 1: Summary
        createSummarySheet(workbook, results);
        
        // Sheet 2: All Differences (Detailed)
        createDetailedDifferencesSheet(workbook, results);
        
        // Sheet 3: Matched Files
        createMatchedFilesSheet(workbook, results);
        
        // Sheet 4: Statistics
        createStatisticsSheet(workbook, results);
        
        // Write to file
        try (FileOutputStream fos = new FileOutputStream(excelPath)) {
            workbook.write(fos);
        }
    }
}

/**
 * Create Summary Sheet - Overview of all files
 */
private static void createSummarySheet(Workbook workbook, 
                                      List<ComparisonResult> results) {
    Sheet sheet = workbook.createSheet("Summary");
    
    // Create styles
    CellStyle headerStyle = createHeaderStyle(workbook);
    CellStyle matchedStyle = createMatchedStyle(workbook);
    CellStyle diffStyle = createDiffStyle(workbook);
    CellStyle normalStyle = createNormalStyle(workbook);
    
    // Header row
    Row headerRow = sheet.createRow(0);
    String[] headers = {"File Name", "PRE App ID", "POST App ID", "Status", 
                       "Total Differences", "PRE Lines", "POST Lines"};
    for (int i = 0; i < headers.length; i++) {
        Cell cell = headerRow.createCell(i);
        cell.setCellValue(headers[i]);
        cell.setCellStyle(headerStyle);
    }
    
    // Data rows
    int rowNum = 1;
    for (ComparisonResult result : results) {
        Row row = sheet.createRow(rowNum++);
        
        Cell cell0 = row.createCell(0);
        cell0.setCellValue(result.fileName);
        cell0.setCellStyle(normalStyle);
        
        Cell cell1 = row.createCell(1);
        cell1.setCellValue(result.preAppId);
        cell1.setCellStyle(normalStyle);
        
        Cell cell2 = row.createCell(2);
        cell2.setCellValue(result.postAppId);
        cell2.setCellStyle(normalStyle);
        
        Cell cell3 = row.createCell(3);
        cell3.setCellValue(result.status);
        cell3.setCellStyle("MATCHED".equals(result.status) ? matchedStyle : diffStyle);
        
        Cell cell4 = row.createCell(4);
        cell4.setCellValue(result.totalDifferences);
        cell4.setCellStyle(normalStyle);
        
        Cell cell5 = row.createCell(5);
        cell5.setCellValue(result.preFileLines);
        cell5.setCellStyle(normalStyle);
        
        Cell cell6 = row.createCell(6);
        cell6.setCellValue(result.postFileLines);
        cell6.setCellStyle(normalStyle);
    }
    
    // Auto-size columns
    for (int i = 0; i < headers.length; i++) {
        sheet.autoSizeColumn(i);
    }
    
    // Freeze header row
    sheet.createFreezePane(0, 1);
}

/**
 * Create Detailed Differences Sheet - All differences with full details
 */
private static void createDetailedDifferencesSheet(Workbook workbook, 
                                                   List<ComparisonResult> results) {
    Sheet sheet = workbook.createSheet("Detailed Differences");
    
    CellStyle headerStyle = createHeaderStyle(workbook);
    CellStyle normalStyle = createNormalStyle(workbook);
    CellStyle wrapStyle = createWrapTextStyle(workbook);
    
    // Header row
    Row headerRow = sheet.createRow(0);
    String[] headers = {"File Name", "PRE App ID", "POST App ID", "Line #", 
                       "Path", "Bureau", "Type", "Parsed", "PRE Content", "POST Content"};
    for (int i = 0; i < headers.length; i++) {
        Cell cell = headerRow.createCell(i);
        cell.setCellValue(headers[i]);
        cell.setCellStyle(headerStyle);
    }
    
    // Data rows
    int rowNum = 1;
    for (ComparisonResult result : results) {
        if ("DIFFERENCES FOUND".equals(result.status)) {
            for (DifferenceDetail diff : result.differences) {
                Row row = sheet.createRow(rowNum++);
                
                row.createCell(0).setCellValue(result.fileName);
                row.createCell(1).setCellValue(result.preAppId);
                row.createCell(2).setCellValue(result.postAppId);
                row.createCell(3).setCellValue(diff.lineNumber);
                
                Cell pathCell = row.createCell(4);
                pathCell.setCellValue(diff.path);
                pathCell.setCellStyle(wrapStyle);
                
                row.createCell(5).setCellValue(diff.bureau);
                row.createCell(6).setCellValue(diff.type);
                row.createCell(7).setCellValue(diff.parsed);
                
                Cell preCell = row.createCell(8);
                preCell.setCellValue(diff.preContent);
                preCell.setCellStyle(wrapStyle);
                
                Cell postCell = row.createCell(9);
                postCell.setCellValue(diff.postContent);
                postCell.setCellStyle(wrapStyle);
                
                // Apply normal style to non-wrap cells
                for (int i = 0; i < 4; i++) {
                    row.getCell(i).setCellStyle(normalStyle);
                }
                for (int i = 5; i < 8; i++) {
                    row.getCell(i).setCellStyle(normalStyle);
                }
            }
        }
    }
    
    // Set column widths
    sheet.setColumnWidth(0, 8000);  // File Name
    sheet.setColumnWidth(1, 4000);  // PRE App ID
    sheet.setColumnWidth(2, 4000);  // POST App ID
    sheet.setColumnWidth(3, 3000);  // Line #
    sheet.setColumnWidth(4, 15000); // Path
    sheet.setColumnWidth(5, 6000);  // Bureau
    sheet.setColumnWidth(6, 4000);  // Type
    sheet.setColumnWidth(7, 8000);  // Parsed
    sheet.setColumnWidth(8, 20000); // PRE Content
    sheet.setColumnWidth(9, 20000); // POST Content
    
    // Freeze header row
    sheet.createFreezePane(0, 1);
}

/**
 * Create Matched Files Sheet - Files with no differences
 */
private static void createMatchedFilesSheet(Workbook workbook, 
                                           List<ComparisonResult> results) {
    Sheet sheet = workbook.createSheet("Matched Files");
    
    CellStyle headerStyle = createHeaderStyle(workbook);
    CellStyle matchedStyle = createMatchedStyle(workbook);
    
    // Header row
    Row headerRow = sheet.createRow(0);
    String[] headers = {"File Name", "PRE App ID", "POST App ID", "Status", 
                       "PRE Lines", "POST Lines"};
    for (int i = 0; i < headers.length; i++) {
        Cell cell = headerRow.createCell(i);
        cell.setCellValue(headers[i]);
        cell.setCellStyle(headerStyle);
    }
    
    // Data rows - only matched files
    int rowNum = 1;
    for (ComparisonResult result : results) {
        if ("MATCHED".equals(result.status)) {
            Row row = sheet.createRow(rowNum++);
            
            Cell cell0 = row.createCell(0);
            cell0.setCellValue(result.fileName);
            cell0.setCellStyle(matchedStyle);
            
            Cell cell1 = row.createCell(1);
            cell1.setCellValue(result.preAppId);
            cell1.setCellStyle(matchedStyle);
            
            Cell cell2 = row.createCell(2);
            cell2.setCellValue(result.postAppId);
            cell2.setCellStyle(matchedStyle);
            
            Cell cell3 = row.createCell(3);
            cell3.setCellValue(result.status);
            cell3.setCellStyle(matchedStyle);
            
            Cell cell4 = row.createCell(4);
            cell4.setCellValue(result.preFileLines);
            cell4.setCellStyle(matchedStyle);
            
            Cell cell5 = row.createCell(5);
            cell5.setCellValue(result.postFileLines);
            cell5.setCellStyle(matchedStyle);
        }
    }
    
    // Auto-size columns
    for (int i = 0; i < headers.length; i++) {
        sheet.autoSizeColumn(i);
    }
    
    // Freeze header row
    sheet.createFreezePane(0, 1);
}

/**
 * Create Statistics Sheet - Overall statistics
 */
private static void createStatisticsSheet(Workbook workbook, 
                                         List<ComparisonResult> results) {
    Sheet sheet = workbook.createSheet("Statistics");
    
    CellStyle labelStyle = createBoldStyle(workbook);
    CellStyle valueStyle = createNormalStyle(workbook);
    
    int rowNum = 0;
    
    // Calculate statistics
    int totalFiles = results.size();
    int matchedFiles = (int) results.stream()
        .filter(r -> "MATCHED".equals(r.status)).count();
    int filesWithDiffs = totalFiles - matchedFiles;
    int totalDifferences = results.stream()
        .mapToInt(r -> r.totalDifferences).sum();
    
    // Statistics rows
    addStatRow(sheet, rowNum++, "Total Files Compared:", totalFiles, 
               labelStyle, valueStyle);
    addStatRow(sheet, rowNum++, "Files with Matches:", matchedFiles, 
               labelStyle, valueStyle);
    addStatRow(sheet, rowNum++, "Files with Differences:", filesWithDiffs, 
               labelStyle, valueStyle);
    addStatRow(sheet, rowNum++, "Total Differences Found:", totalDifferences, 
               labelStyle, valueStyle);
    
    rowNum++; // Empty row
    
    // Breakdown by category
    Row categoryHeaderRow = sheet.createRow(rowNum++);
    Cell catHeader = categoryHeaderRow.createCell(0);
    catHeader.setCellValue("Breakdown by Category:");
    catHeader.setCellStyle(labelStyle);
    
    Map<String, Long> categoryCount = results.stream()
        .collect(Collectors.groupingBy(
            r -> r.fileName.toUpperCase().contains("CLI") ? "CLI" :
                 r.fileName.toUpperCase().contains("PRQ") ? "PRQ" : "ACQ",
            Collectors.counting()));
    
    for (Map.Entry<String, Long> entry : categoryCount.entrySet()) {
        Row catRow = sheet.createRow(rowNum++);
        Cell labelCell = catRow.createCell(1);
        labelCell.setCellValue(entry.getKey() + ":");
        labelCell.setCellStyle(labelStyle);
        
        Cell valueCell = catRow.createCell(2);
        valueCell.setCellValue(entry.getValue());
        valueCell.setCellStyle(valueStyle);
    }
    
    // Auto-size columns
    sheet.autoSizeColumn(0);
    sheet.autoSizeColumn(1);
    sheet.autoSizeColumn(2);
}

/**
 * Helper method to add statistics row
 */
private static void addStatRow(Sheet sheet, int rowNum, String label, 
                              int value, CellStyle labelStyle, CellStyle valueStyle) {
    Row row = sheet.createRow(rowNum);
    
    Cell labelCell = row.createCell(0);
    labelCell.setCellValue(label);
    labelCell.setCellStyle(labelStyle);
    
    Cell valueCell = row.createCell(1);
    valueCell.setCellValue(value);
    valueCell.setCellStyle(valueStyle);
}

// ============================================================================
// EXCEL STYLE CREATION METHODS
// ============================================================================

private static CellStyle createHeaderStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    Font font = workbook.createFont();
    font.setBold(true);
    font.setFontHeightInPoints((short) 11);
    font.setColor(IndexedColors.WHITE.getIndex());
    style.setFont(font);
    style.setFillForegroundColor(IndexedColors.DARK_BLUE.getIndex());
    style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
    style.setAlignment(HorizontalAlignment.CENTER);
    style.setVerticalAlignment(VerticalAlignment.CENTER);
    style.setBorderBottom(BorderStyle.THIN);
    style.setBorderTop(BorderStyle.THIN);
    style.setBorderLeft(BorderStyle.THIN);
    style.setBorderRight(BorderStyle.THIN);
    return style;
}

private static CellStyle createMatchedStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    style.setFillForegroundColor(IndexedColors.LIGHT_GREEN.getIndex());
    style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
    style.setBorderBottom(BorderStyle.THIN);
    style.setBorderTop(BorderStyle.THIN);
    style.setBorderLeft(BorderStyle.THIN);
    style.setBorderRight(BorderStyle.THIN);
    return style;
}

private static CellStyle createDiffStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    style.setFillForegroundColor(IndexedColors.LIGHT_ORANGE.getIndex());
    style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
    style.setBorderBottom(BorderStyle.THIN);
    style.setBorderTop(BorderStyle.THIN);
    style.setBorderLeft(BorderStyle.THIN);
    style.setBorderRight(BorderStyle.THIN);
    return style;
}

private static CellStyle createNormalStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    style.setBorderBottom(BorderStyle.THIN);
    style.setBorderTop(BorderStyle.THIN);
    style.setBorderLeft(BorderStyle.THIN);
    style.setBorderRight(BorderStyle.THIN);
    style.setVerticalAlignment(VerticalAlignment.TOP);
    return style;
}

private static CellStyle createWrapTextStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    style.setWrapText(true);
    style.setBorderBottom(BorderStyle.THIN);
    style.setBorderTop(BorderStyle.THIN);
    style.setBorderLeft(BorderStyle.THIN);
    style.setBorderRight(BorderStyle.THIN);
    style.setVerticalAlignment(VerticalAlignment.TOP);
    return style;
}

private static CellStyle createBoldStyle(Workbook workbook) {
    CellStyle style = workbook.createCellStyle();
    Font font = workbook.createFont();
    font.setBold(true);
    style.setFont(font);
    return style;
}

// In the main() method, replace the section after master report generation:

// Save master report (existing code)
String masterReportPath = outputFolder + "\\MASTER_comparison_report.txt";
try (FileWriter writer = new FileWriter(masterReportPath)) {
    writer.write(masterReport.toString());
    System.out.println("\n✅ Master comparison report saved: " + masterReportPath);
}

// **ADD THIS NEW CODE HERE** - Generate Excel report
generateExcelReport(masterReportPath, outputFolder);

markRunCompleted(outputFolder);
Also add these required imports at the top of your file:
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;